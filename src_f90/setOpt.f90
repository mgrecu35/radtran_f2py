subroutine updateTbsL(n1c21,tbObs,tbout2D,tb,fpmap, ialg)
  implicit none
  integer n1c21
  real   :: tbObs(49,300,9), tbOut2D(49,300,9), tb(49,300,9)
  real   :: cl(9,25), xin25(25),dtb(9)
  real :: tbMax1(9), tbMin1(9)
  integer :: i1, j1, i,j,k
  integer :: ialg
  real ::  fpmap(49,300,9), alpha
  alpha=1.
  
  if(ialg==1) alpha=1.2
  
  cl(1,:)=(/ 0.48318141, -0.41663378, -0.01303624, -1.15086397,  0.05673511, &
       -0.71320201,  0.4318979 ,  1.26894106, -0.21114584,  0.58801472, &
       -1.20518243,  0.31497959,  1.9009947 ,  0.17086872, -1.14414603, &
       0.85589993, -0.05822644,  1.22770565,  0.39205652, -0.51163002,& 
       0.0096993 , -1.32830387, -0.11412764, -0.35989504,  0.52469544/)

  cl(3,:)=(/ 0.04597305,  0.01584686, -0.11650506, -0.12520161,  0.06716505, &
       0.12318447, -0.31960293,  0.37007714, -0.31280201,  0.00909487, &
       -0.1751697 , -0.14547126,  2.10105009, -0.15740144, -0.15508691, &
       0.03397669, -0.31293807,  0.3761382 , -0.3120244 ,  0.12311661, &
       0.06815432, -0.14238958, -0.12108163,  0.02308029,  0.03882681/)

  cl(3,:)=(/-0.0256737 ,  0.10104768, -0.14950079, -0.01974256,  0.06844021,&
       0.23362576, -0.43041254,  0.25359462, -0.56752957,  0.07510691, &
       -0.16704151, -0.34692595,  2.92190593, -0.36634653, -0.13435232, &
       0.10616977, -0.57366605,  0.26264393, -0.42288752,  0.22556978, &
       0.06746544, -0.03517716, -0.15326787,  0.10890432, -0.03192615/)

  cl(3,:)=(/ 0.07255256, -0.01779807, -0.10844479, -0.14655981,  0.04769092,&
       0.06580105, -0.24592615,  0.38812959, -0.18347469, -0.01605963,&
       -0.17447393, -0.04847292,  1.71091443, -0.05683074, -0.16091874,&
       0.0060294 , -0.1826541 ,  0.39276434, -0.23804975,  0.06844657,&
       0.04866109, -0.16281307, -0.11317885, -0.01126003,  0.06592521/)

  cl(3,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)


  cl(5,:)=(/ 0.04735428,  0.00287256, -0.11894717, -0.0778702 ,  0.04936086,&
       0.05368457, -0.15049347,  0.20225169, -0.1676597 , -0.03845573,&
       -0.16740492,  0.02438567,  1.63495822,  0.03076686, -0.14588892,&
       -0.01119539, -0.15798574,  0.20866967, -0.15171043,  0.05079404,&
       0.04794318, -0.09170455, -0.12376752,  0.00218955,  0.047865  /)
  cl(6,:)=(/ 3.71559578e-04,   2.06669144e-04,   3.65559236e-04, &
       -1.22723624e-04,   4.37758679e-04,  -8.18755666e-04, &
       -5.59193011e-04,  -2.86814691e-02,  -9.03037587e-03, &
       -6.72932451e-04,   2.90153537e-04,  -1.57983345e-02, &
       1.10844456e+00,  -1.63503805e-02,   2.75743122e-04, &
       -8.95305247e-04,  -9.29794742e-03,  -2.85491284e-02, &
       -4.03805734e-06,  -7.81602266e-04,   6.61657162e-04, &
       -2.28765677e-04,   2.97200112e-04,   1.91998055e-04, &
       2.61987084e-04/)
  cl(1,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)
  cl(5,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)
  !rerr=(/2.,2.,2.,2.,2.,2.,2.,2.,2./)
  tbMax1=(/ 285.96795654,284.71334839,286.23388672,284.92977905,286.37451172,&
       287.90933228,286.43515015,284.8597412,284.51959229/)
  tbMin1=(/175.59274292,95.61299896,215.97111511,161.71897888,205.35340881,&
       143.96331787,143.96331787,87.26193237,87.26193237/)
  tbMin1=(/167.43344116,   86.27742767,  200.01838684,  134.10232544, &
       205.35340881,&
       143.96331787,143.96331787,87.26193237,87.26193237/)

do j=3,n1c21-3
   do i=3,49-2
     dtb(1:9)=0
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,1:2))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,1:2))>0) then
         do i1=1,5
            do j1=1,5
               dtb(1:2)=dtb(1:2)+(tbObs(i+i1-3,j+j1-3,1:2)-&
                    tbout2D(i+i1-3,j+j1-3,1:2))*cl(1,(i1-1)*5+j1)
            enddo
         enddo
      endif
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,3:4))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,3:4))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(3:4)=dtb(3:4)+(tbObs(i+i1-3,j+j1-3,3:4)-&
                       tbout2D(i+i1-3,j+j1-3,3:4) )*cl(3,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,5))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,5))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(5)=dtb(5)+(tbObs(i+i1-3,j+j1-3,5)-&
                    tbout2D(i+i1-3,j+j1-3,5))*cl(5,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,6:9))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,6:9))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(6:9)=dtb(6:9)+(tbObs(i+i1-3,j+j1-3,6:9)-&
                       tbout2D(i+i1-3,j+j1-3,6:9))*cl(6,(i1-1)*5+j1)
               enddo
            enddo
            
         tb(i,j,1:9)=tb(i,j,1:9)+alpha*dtb(1:9)
         do i1=1,9
            if(fpmap(i,j,i1)>0) then
               !if(tb(i,j,i1)<tbMin1(i1)-20) tb(i,j,i1)=tbMin1(i1)-20
               !if(tb(i,j,i1)>tbMax1(i1)+20) tb(i,j,i1)=tbMax1(i1)+20
            endif
         enddo
      endif
   enddo
enddo


do j=3,n1c21-3
   do i=3,49-2
     dtb(1:9)=0
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,1:2))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,1:2))<=0 ) then
         do i1=1,5
            do j1=1,5
               dtb(1:2)=dtb(1:2)+(tbObs(i+i1-3,j+j1-3,1:2))*cl(1,(i1-1)*5+j1)
            enddo
         enddo
      endif
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,3:4))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,3:4))<=0 ) then
            do i1=1,5
               do j1=1,5
                  dtb(3:4)=dtb(3:4)+(tbObs(i+i1-3,j+j1-3,3:4))*cl(3,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,5))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,5))<=0 ) then
            do i1=1,5
               do j1=1,5
                  dtb(5)=dtb(5)+(tbObs(i+i1-3,j+j1-3,5))*cl(5,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,6:9))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,6:9))<=0) then
            do i1=1,5
               do j1=1,5
                  dtb(6:9)=dtb(6:9)+(tbObs(i+i1-3,j+j1-3,6:9))*cl(6,(i1-1)*5+j1)
               enddo
            enddo
         tb(i,j,1:9)= 0.75*tb(i,j,1:9)+0.25*dtb(1:9)
         do i1=1,9
            if(fpmap(i,j,i1)>0) then
               !if(tb(i,j,i1)<tbMin1(i1)-20) tb(i,j,i1)=tbMin1(i1)-20
               !if(tb(i,j,i1)>tbMax1(i1)+20) tb(i,j,i1)=tbMax1(i1)+20
            endif
         enddo
      endif
   enddo
enddo

end subroutine updateTbsL
subroutine updateTbs(n1c21,tbObs,tbout2D,tb,fpmap, ialg)
  implicit none
  integer n1c21
!begin  MG 9/17/18 added TbS array
  real   :: tbObs(49,300,9), tbOut2D(49,300,9), tb(49,300,9), tbS(49,300,9)
!end    MG 9/17/18
  real   :: cl(9,25), xin25(25),dtb(9)
  real :: tbMax1(9), tbMin1(9)
  integer :: i1, j1, i,j,k, ialg
!begin  MG 9/17/18 added tmean
  real ::  fpmap(49,300,9), alpha, tmean
!end    MG 9/17/18

  alpha=1
!begin  MG 9/17/18 added alpha change if ialg = 2
  if(ialg==1) alpha=1.2
  if(ialg==2) alpha=1.5
!end    MG 9/17/18
  cl(1,:)=(/ 0.48318141, -0.41663378, -0.01303624, -1.15086397,  0.05673511, &
       -0.71320201,  0.4318979 ,  1.26894106, -0.21114584,  0.58801472, &
       -1.20518243,  0.31497959,  1.9009947 ,  0.17086872, -1.14414603, &
       0.85589993, -0.05822644,  1.22770565,  0.39205652, -0.51163002,& 
       0.0096993 , -1.32830387, -0.11412764, -0.35989504,  0.52469544/)

  cl(3,:)=(/ 0.04597305,  0.01584686, -0.11650506, -0.12520161,  0.06716505, &
       0.12318447, -0.31960293,  0.37007714, -0.31280201,  0.00909487, &
       -0.1751697 , -0.14547126,  2.10105009, -0.15740144, -0.15508691, &
       0.03397669, -0.31293807,  0.3761382 , -0.3120244 ,  0.12311661, &
       0.06815432, -0.14238958, -0.12108163,  0.02308029,  0.03882681/)

  cl(3,:)=(/-0.0256737 ,  0.10104768, -0.14950079, -0.01974256,  0.06844021,&
       0.23362576, -0.43041254,  0.25359462, -0.56752957,  0.07510691, &
       -0.16704151, -0.34692595,  2.92190593, -0.36634653, -0.13435232, &
       0.10616977, -0.57366605,  0.26264393, -0.42288752,  0.22556978, &
       0.06746544, -0.03517716, -0.15326787,  0.10890432, -0.03192615/)

  cl(3,:)=(/ 0.07255256, -0.01779807, -0.10844479, -0.14655981,  0.04769092,&
       0.06580105, -0.24592615,  0.38812959, -0.18347469, -0.01605963,&
       -0.17447393, -0.04847292,  1.71091443, -0.05683074, -0.16091874,&
       0.0060294 , -0.1826541 ,  0.39276434, -0.23804975,  0.06844657,&
       0.04866109, -0.16281307, -0.11317885, -0.01126003,  0.06592521/)

  cl(3,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)


  cl(5,:)=(/ 0.04735428,  0.00287256, -0.11894717, -0.0778702 ,  0.04936086,&
       0.05368457, -0.15049347,  0.20225169, -0.1676597 , -0.03845573,&
       -0.16740492,  0.02438567,  1.63495822,  0.03076686, -0.14588892,&
       -0.01119539, -0.15798574,  0.20866967, -0.15171043,  0.05079404,&
       0.04794318, -0.09170455, -0.12376752,  0.00218955,  0.047865  /)
  cl(6,:)=(/ 3.71559578e-04,   2.06669144e-04,   3.65559236e-04, &
       -1.22723624e-04,   4.37758679e-04,  -8.18755666e-04, &
       -5.59193011e-04,  -2.86814691e-02,  -9.03037587e-03, &
       -6.72932451e-04,   2.90153537e-04,  -1.57983345e-02, &
       1.10844456e+00,  -1.63503805e-02,   2.75743122e-04, &
       -8.95305247e-04,  -9.29794742e-03,  -2.85491284e-02, &
       -4.03805734e-06,  -7.81602266e-04,   6.61657162e-04, &
       -2.28765677e-04,   2.97200112e-04,   1.91998055e-04, &
       2.61987084e-04/)
  cl(1,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)
  cl(5,:)=(/ 8.41984740e-02,  -4.83139101e-02,  -9.83599407e-02, &
       -1.37761142e-01,  -2.37761475e-04,  -4.99710870e-03, &
       -1.32699861e-01,   3.68062637e-01,  -1.43887705e-02, &
        -3.97611581e-02,  -1.58763890e-01,   7.57133896e-02, &
        1.19762173e+00,   7.19336590e-02,  -1.54099483e-01, &
        -2.22257460e-02,  -1.43426010e-02,   3.70682572e-01, &
        -1.25071300e-01,  -9.62714792e-04,  -2.21332364e-04, &
        -1.50845129e-01,  -1.02037026e-01,  -4.28373782e-02, &
         7.96988911e-02/)
  !rerr=(/2.,2.,2.,2.,2.,2.,2.,2.,2./)
  tbMax1=(/ 285.96795654,284.71334839,286.23388672,284.92977905,286.37451172,&
       287.90933228,286.43515015,284.8597412,284.51959229/)
  tbMin1=(/175.59274292,95.61299896,215.97111511,161.71897888,205.35340881,&
       143.96331787,143.96331787,87.26193237,87.26193237/)
  tbMin1=(/167.43344116,   86.27742767,  200.01838684,  134.10232544, &
       205.35340881,&
       143.96331787,143.96331787,87.26193237,87.26193237/)

do j=3,n1c21-3
   do i=3,49-2
     dtb(1:9)=0
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,1:2))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,1:2))>0) then
         do i1=1,5
            do j1=1,5
               dtb(1:2)=dtb(1:2)+(tbObs(i+i1-3,j+j1-3,1:2)-&
                    tbout2D(i+i1-3,j+j1-3,1:2))*cl(1,(i1-1)*5+j1)
            enddo
         enddo
      endif
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,3:4))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,3:4))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(3:4)=dtb(3:4)+(tbObs(i+i1-3,j+j1-3,3:4)-&
                       tbout2D(i+i1-3,j+j1-3,3:4) )*cl(3,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,5))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,5))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(5)=dtb(5)+(tbObs(i+i1-3,j+j1-3,5)-&
                    tbout2D(i+i1-3,j+j1-3,5))*cl(5,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,6:9))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,6:9))>0) then
            do i1=1,5
               do j1=1,5
                  dtb(6:9)=dtb(6:9)+(tbObs(i+i1-3,j+j1-3,6:9)-&
                       tbout2D(i+i1-3,j+j1-3,6:9))*cl(6,(i1-1)*5+j1)
               enddo
            enddo
            
         tb(i,j,1:9)=tb(i,j,1:9)+alpha*dtb(1:9)
         do i1=1,9
            if(fpmap(i,j,i1)>0) then
               if(tb(i,j,i1)<tbMin1(i1)-20) tb(i,j,i1)=tbMin1(i1)-20
               if(tb(i,j,i1)>tbMax1(i1)+20) tb(i,j,i1)=tbMax1(i1)+20
            endif
         enddo
      endif
   enddo
enddo


do j=3,n1c21-3
   do i=3,49-2
     dtb(1:9)=0
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,1:2))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,1:2))<=0 ) then
         do i1=1,5
            do j1=1,5
               dtb(1:2)=dtb(1:2)+(tbObs(i+i1-3,j+j1-3,1:2))*cl(1,(i1-1)*5+j1)
            enddo
         enddo
      endif
      if( &
           minval(tbObs(i-2:i+2,j-2:j+2,3:4))>0 .and. &
           minval(tbout2D(i-2:i+2,j-2:j+2,3:4))<=0 ) then
            do i1=1,5
               do j1=1,5
                  dtb(3:4)=dtb(3:4)+(tbObs(i+i1-3,j+j1-3,3:4))*cl(3,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,5))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,5))<=0 ) then
            do i1=1,5
               do j1=1,5
                  dtb(5)=dtb(5)+(tbObs(i+i1-3,j+j1-3,5))*cl(5,(i1-1)*5+j1)
               enddo
            enddo
         endif
         if( &
              minval(tbObs(i-2:i+2,j-2:j+2,6:9))>0 .and. &
              minval(tbout2D(i-2:i+2,j-2:j+2,6:9))<=0) then
            do i1=1,5
               do j1=1,5
                  dtb(6:9)=dtb(6:9)+(tbObs(i+i1-3,j+j1-3,6:9))*cl(6,(i1-1)*5+j1)
               enddo
            enddo
!begin  MG 9/17/18 revised tb adjustment
         if(ialg == 1) then 
           tb(i,j,1:9)= 0.75*tb(i,j,1:9)+0.25*dtb(1:9)
         else
           tb(i,j,1:9)= (1-0.25*alpha)*tb(i,j,1:9)+alpha*0.25*dtb(1:9)
         endif
!end    MG 9/17/18
         do i1=1,9
            if(fpmap(i,j,i1)>0) then
               if(tb(i,j,i1)<tbMin1(i1)-20) tb(i,j,i1)=tbMin1(i1)-20
               if(tb(i,j,i1)>tbMax1(i1)+20) tb(i,j,i1)=tbMax1(i1)+20
            endif
         enddo
      endif
   enddo
enddo
!begin  MG 9/17/18 assign tmean and calculate tbs
!, tb(49,300,9)
tbs=tb

if(ialg==2) then
   do j=2,n1c21-2
      do i=2,49-1
         if (minval(tb(i,j,1:4))>0) then
            do k=1,4
               tmean=sum(tb(i-1:i+1,j-1:j+1,k))
               tbs(i,j,k)=tb(i,j,k)+0.5*(9*tb(i,j,k)-tmean)/9.
            enddo
         endif
      enddo
   enddo
   tb=tbs
endif
!end    MG 9/17/18
end subroutine updateTbs

subroutine dotmat(A,B,C,n1,n2,n3)
integer :: n1, n2,n3
real ::  A(n1,n2), B(n2,n3), C(n1,n3)
C=0
do i=1,n1
   do j=1,n3
      do l=1,n2
         C(i,j)=C(i,j)+A(i,l)*B(l,j)
      enddo
   enddo
enddo

end subroutine dotmat
subroutine setoptvars(covTb,invCovTb,tbMean,tbMin,tbMax,tb,tbRgrid,tbObs,wfmap,n,ns,nf)
  implicit none
  integer :: n,ns,nf
  integer :: i, j, ik, jk
  real    :: covTb(n,ns,nf,nf),invcovTb(n,ns,nf,nf),tbMean(n,ns,nf),&
       tb(n,ns,nf), wfmap(n,ns), tbRgrid(9,49,ns), tbObs(49,ns,nf), tbMin(n,ns,nf), tbMax(n,ns,nf)
  real :: covA(9,9), S(9), U(9,9), VT(9,9), work(1000), invCovMean(9,9)
  integer :: n1, lwork, info, i1, icount, l
  real :: diagS(9,9)
  real :: temp(9,9)
  real :: noModel(n,ns), maxTbs(9), minTbs(9)
  invCovTb=0
  noModel=0
  lwork=-1
  print*,ns
  do j=1,ns
     do i=1,49
        do l=1,nf
           tbObs(i,j,l)=tbRgrid(l,i,j)
        enddo
     enddo
  enddo
  !invCovMean=0
  icount=0
  do j=1,ns
     do i=1,49
        if(covTb(i,j,1,1)>0) then
           noModel(i,j)=1.
           n1=9
           lwork=-1
           CALL SGESVD( 'All', 'All', n1, n1, covTb(i,j,:,:), n1,&
                S, U, n1, VT, n1, &
                WORK, LWORK, INFO )
           LWORK = MIN(1000 , INT( WORK( 1 ) ) )
           CALL SGESVD( 'All', 'All', n1, n1, covTb(i,j,:,:), n1,&
                S, U, n1, VT, n1, &
                WORK, LWORK, INFO )
           do i1=1,9
              diagS(i1,i1)=0
           enddo
           do i1=1,9
              if (s(i1)>1e-1) then
                 diagS(i1,i1)=1/s(i1)
              else
                 exit
              endif
           enddo
           call dotmat(diagS(1:i1-1,1:i1-1),VT(1:i1-1,1:9),&
                temp(1:i1-1,1:9),i1-1,i1-1,9)
           call dotmat(U(1:9,1:i1-1),temp(1:i1-1,1:9),&
                invCovTb(i,j,1:9,1:9),9,i1-1,9)
           !if(i==3 .and. j==2) print*, invCovTb(i,j,:,:)
           if(wfmap(i,j)>0.95) then
              tb(i,j,:)=tbMean(i,j,:)
              invCovMean=invCovMean+invCovTb(i,j,1:9,1:9)
              icount=icount+1
              !print*, tb(i,j,:)
              !print*, tbObs(i,j,:)
              if(tbObs(i,j,1)>0) then
                 !write(*,110) tbObs(i,j,1:9), tb(i,j,1:9)
              endif
           else
              invCovTb(i,j,:,:)=0
           endif
        endif
        
     enddo
  enddo
  
  invCovMean=invCovMean/icount
!  invCovMean=0.
!  do j=1,9
!     invCovMean(j,j)=1/49.
!  enddo
  do i1=1,9
     !maxTbs(i1)=maxval(TbMax(:,:,i1))
     !minTbs(i1)=minval(TbMin(:,:,i1))
  enddo
  
 do j=1,ns
     do i=1,49
        if(wfmap(i,j)>0.9.and.noModel(i,j)<0.01) then
           invCovTb(i,j,:,:)=0.15*invCovMean
           tb(i,j,:)=tbObs(i,j,:) 
           tbMean(i,j,:)=tbObs(i,j,:)
           tbMax(i,j,:)=tbObs(i,j,:)+30.
           tbMin(i,j,:)=tbObs(i,j,:)-10.
        endif
     enddo
  enddo
  invCovTb=invCovTb*0.75
110 format(18(F8.2,1x))

end subroutine setoptvars
